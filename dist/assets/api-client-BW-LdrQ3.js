import{av as f,aw as c,b as i}from"./index-DpFIowpL.js";const l="https://service.starhalo.io".trim()||"https://starhalo.mangcoding.com",p=l.replace(/\/+$/,""),y=f.create({baseURL:p,headers:new c({Accept:"application/json"})});let a=null;function h(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function A(e){const t=typeof e=="number"?e:typeof e=="string"?Number(e):NaN;return!Number.isFinite(t)||t<=0?null:Date.now()+t*1e3}function T(e){if(!h(e))return null;const t=h(e.data)?e.data:e,s=typeof t.access_token=="string"?t.access_token:typeof e.access_token=="string"?e.access_token:null;if(!s)return null;const r=typeof t.refresh_token=="string"?t.refresh_token:typeof e.refresh_token=="string"?e.refresh_token:null,o=typeof t.token_type=="string"?t.token_type:typeof e.token_type=="string"?e.token_type:null,n=A(t.expires_in??e.expires_in)??null;return{accessToken:s,refreshToken:r,tokenType:o,expiresAt:n}}async function k(){const{auth:e}=i.getState();return e.refreshToken?(a||(a=y.post("/api/auth/admin/refresh",{refresh_token:e.refreshToken}).then(({data:t})=>{const s=T(t);if(!s?.accessToken)throw new Error(t?.message??"Unable to refresh authentication token.");const r=e.expiresAt&&e.expiresAt>Date.now()?e.expiresAt:null,o={accessToken:s.accessToken,refreshToken:s.refreshToken??e.refreshToken,tokenType:s.tokenType??e.tokenType??"Bearer",expiresAt:s.expiresAt??r};return i.getState().auth.setSession(o),o}).catch(t=>{throw i.getState().auth.reset(),t}).finally(()=>{a=null})),a):null}async function m(){const{auth:e}=i.getState();e.accessToken&&e.expiresAt&&e.expiresAt>0&&e.expiresAt-Date.now()<=5e3&&await k()}const u=f.create({baseURL:p,headers:new c({Accept:"application/json"})});u.interceptors.request.use(async e=>{await m();const{auth:t}=i.getState(),s=t.accessToken;return s&&(e.headers||=new c(e.headers)).set("Authorization",`${t.tokenType??"Bearer"} ${s}`.trim()),e});u.interceptors.response.use(e=>e,async e=>{const t=e.response?.status,s=e.config,r=s?.url??"",o=typeof r=="string"&&(/\/api\/auth\/admin\/(login|refresh)/.test(r)||r.endsWith("/api/auth/admin/login")||r.endsWith("/api/auth/admin/refresh"));if(t===401&&s&&!s._retry&&!o){s._retry=!0;try{await k();const{auth:n}=i.getState();if(n.accessToken)return(s.headers||=new c(s.headers)).set("Authorization",`${n.tokenType??"Bearer"} ${n.accessToken}`.trim()),u.request(s)}catch(n){return Promise.reject(n)}}return Promise.reject(e)});export{u as a};
