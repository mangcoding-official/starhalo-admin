import{av as f,aw as c,a}from"./index-PJSoALqW.js";const l="https://starhalo.mangcoding.com".trim()||"https://starhalo.mangcoding.com",p=l.replace(/\/+$/,""),m=f.create({baseURL:p,headers:new c({Accept:"application/json"})});let i=null;function h(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function y(e){const t=typeof e=="number"?e:typeof e=="string"?Number(e):NaN;return!Number.isFinite(t)||t<=0?null:Date.now()+t*1e3}function g(e){if(!h(e))return null;const t=h(e.data)?e.data:e,s=typeof t.access_token=="string"?t.access_token:typeof e.access_token=="string"?e.access_token:null;if(!s)return null;const n=typeof t.refresh_token=="string"?t.refresh_token:typeof e.refresh_token=="string"?e.refresh_token:null,o=typeof t.token_type=="string"?t.token_type:typeof e.token_type=="string"?e.token_type:null,r=y(t.expires_in??e.expires_in)??null;return{accessToken:s,refreshToken:n,tokenType:o,expiresAt:r}}async function k(){const{auth:e}=a.getState();return e.refreshToken?(i||(i=m.post("/api/auth/admin/refresh",{refresh_token:e.refreshToken}).then(({data:t})=>{const s=g(t);if(!s?.accessToken)throw new Error(t?.message??"Unable to refresh authentication token.");const n=e.expiresAt&&e.expiresAt>Date.now()?e.expiresAt:null,o={accessToken:s.accessToken,refreshToken:s.refreshToken??e.refreshToken,tokenType:s.tokenType??e.tokenType??"Bearer",expiresAt:s.expiresAt??n};return a.getState().auth.setSession(o),o}).catch(t=>{throw a.getState().auth.reset(),t}).finally(()=>{i=null})),i):null}async function A(){const{auth:e}=a.getState();e.accessToken&&e.expiresAt&&e.expiresAt>0&&e.expiresAt-Date.now()<=5e3&&await k()}const u=f.create({baseURL:p,headers:new c({Accept:"application/json"})});u.interceptors.request.use(async e=>{await A();const{auth:t}=a.getState(),s=t.accessToken;return s&&(e.headers||=new c(e.headers)).set("Authorization",`${t.tokenType??"Bearer"} ${s}`.trim()),e});u.interceptors.response.use(e=>e,async e=>{const t=e.response?.status,s=e.config,n=s?.url??"",o=typeof n=="string"&&(/\/api\/auth\/admin\/(login|refresh)/.test(n)||n.endsWith("/api/auth/admin/login")||n.endsWith("/api/auth/admin/refresh"));if(t===401&&s&&!s._retry&&!o){s._retry=!0;try{await k();const{auth:r}=a.getState();if(r.accessToken)return(s.headers||=new c(s.headers)).set("Authorization",`${r.tokenType??"Bearer"} ${r.accessToken}`.trim()),u.request(s)}catch(r){return Promise.reject(r)}}return Promise.reject(e)});export{u as a};
