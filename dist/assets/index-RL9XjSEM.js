import{r as b,j as e,R as we,u as F,B as U,o as y,y as k,D as L,s as l,z as oe,n as j,i as Z,l as Ne,E as $e,Z as se,k as ke,C as Le,t as _}from"./index-BPSZ23yK.js";import{C as ze}from"./config-drawer-CJ7gz8yj.js";import{a as Oe,u as Ve,C as He,H as Be,S as qe}from"./search-BH8cG_Mc.js";import{M as Ge}from"./main-DDuuTw6d.js";import{P as Ye}from"./profile-dropdown-ck0BZhfN.js";import{T as Ke}from"./theme-switch-COF_DH2B.js";import{P as Qe}from"./plus-DEzdOU0p.js";import{D as A,u as Ze,a as Je,g as Xe,b as We,c as et,d as tt,e as st,f as at,h as nt,T as it,i as rt,j as O,k as ot,l as me,m as lt,n as ae,o as ct}from"./toolbar-CBjoaQVP.js";import{S as ut}from"./skeleton-D2l6--hT.js";import{g as dt}from"./get-row-serial-lFSYfpsv.js";import{D as mt}from"./react-icons.esm-CfnrlJZh.js";import{D as pt,f as ht,g as gt,j as pe,O as he,i as ft}from"./dropdown-menu-CywYzuBz.js";import{E as xt}from"./eye-1J8epcHx.js";import{T as bt}from"./trash-2-BFlGjZhg.js";import{f as K}from"./format-DMm6umYn.js";import{i as ne,u as ie}from"./id-D_VBRjLd.js";import{u as jt,a as yt,F as wt,b as V,c as H,d as B,e as q,f as G,h as Nt}from"./form-CtqYgiyz.js";import{s as St}from"./show-submitted-data-CQhPAlMe.js";import{D as Se,a as ve,b as Pe,c as De,d as Ce,e as vt,f as Pt}from"./command-Bn0Ghmfc.js";import{I as re}from"./input-DuMOtWk2.js";import{T as Dt}from"./textarea-CiM6Sa1N.js";import{a as J}from"./api-client-m-KTob-k.js";import"./index-DjD6NQHy.js";import"./index-E6AtwoD-.js";import"./index-l18ud2wc.js";import"./index-D3o07efQ.js";import"./index-CO7e1cEs.js";import"./index-BzljWo5j.js";import"./index-CcqO3QxQ.js";import"./index-_hsB4uYA.js";import"./layout-provider-ClEEKa2B.js";import"./separator-DC7n6DXS.js";import"./index-DkEBYZ69.js";import"./check-DdWDy1wJ.js";import"./select-UXgEQtMQ.js";import"./index-q5h3T6pY.js";import"./index-CapyU3Ll.js";import"./chevron-down-Ew3f4PwD.js";import"./badge-taik_GfK.js";import"./popover-MHnAXzd2.js";const Me=we.createContext(null);function Ct({children:t}){const[s,a]=Oe(null),[n,o]=b.useState(null);return e.jsx(Me.Provider,{value:{open:s,setOpen:a,currentRow:n,setCurrentRow:o},children:t})}const le=()=>{const t=we.useContext(Me);if(!t)throw new Error("usePushNotifications has to be used within <PushNotificationProvider>");return t};function Mt(){const{setOpen:t}=le(),{t:s}=F();return e.jsx("div",{className:"flex gap-2",children:e.jsxs(U,{className:"space-x-1",onClick:()=>t("create"),children:[e.jsx("span",{children:s("push.buttons.create","Create")})," ",e.jsx(Qe,{size:18})]})})}const _t=["draft","scheduled","sent","canceled","failed","sending"],X=["all","platform","user","segment","role"],W=["normal","high"],ee=k(_t),ce=y({id:l(),title:l(),content:l(),imageUrl:l().nullable().optional(),target:k(X).default("all"),criteria:L().nullable().optional(),priority:k(W).default("normal"),scheduleDate:l().nullable().optional(),status:ee,sentAt:l().nullable().optional(),createdBy:l().nullable().optional(),createdAt:l().nullable().optional(),updatedAt:l().nullable().optional(),resultSummary:L().nullable().optional()}),Ft=ce.pick({id:!0,title:!0,content:!0,scheduleDate:!0,status:!0,sentAt:!0});y({title:l().min(1,"Title is required").max(80),content:l().min(1,"Content is required").max(240),target:k(X).default("all"),criteria:L().nullable().optional(),priority:k(W).default("normal"),status:ee.default("draft"),scheduleDate:l().optional().nullable()}).superRefine((t,s)=>{(t.status==="scheduled"||t.status==="sending")&&!t.scheduleDate&&s.addIssue({code:"custom",path:["scheduleDate"],message:"Schedule date is required when status is Scheduled/Sending"})});y({q:l().optional(),status:ee.optional(),page:j().int().min(1).default(1),perPage:j().int().min(1).max(100).default(10)});const At=y({total:j().int().nonnegative(),page:j().int().min(1),perPage:j().int().min(1)});y({data:Z(Ft),meta:At});const R=y({id:oe([l(),j()]),title:l().nullable().optional(),message:l().nullable().optional(),content:l().nullable().optional(),description:l().nullable().optional(),body:l().nullable().optional(),status:l().nullable().optional(),target:l().nullable().optional(),priority:l().nullable().optional(),criteria:L().nullable().optional(),image:l().nullable().optional(),image_url:l().nullable().optional(),schedule_at:l().nullable().optional(),scheduled_at:l().nullable().optional(),send_at:l().nullable().optional(),sent_at:l().nullable().optional(),created_by:oe([l(),j(),y({name:l().optional()})]).nullable().optional(),created_at:l().nullable().optional(),updated_at:l().nullable().optional(),result_summary:L().nullable().optional()});function T(t){if(!t)return null;const s=t.trim();if(!s)return null;const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toISOString()}function Tt(t){switch((t??"").toLowerCase()){case"scheduled":case"schedule":case"publish":case"published":return"scheduled";case"sending":return"sending";case"sent":return"sent";case"canceled":case"cancelled":return"canceled";case"failed":return"failed";case"draft":default:return"draft"}}function Rt(t){const s=(t??"").toLowerCase(),a="all";return X.includes(s)?s:a}function It(t){const s=(t??"").toLowerCase(),a="normal";return W.includes(s)?s:a}function $(t){const s=R.parse(t),a=T(s.schedule_at)??T(s.scheduled_at)??T(s.send_at),n=T(s.sent_at??s.send_at),o=T(s.created_at),i=T(s.updated_at??s.created_at),u="https://service.starhalo.io".trim()||"https://starhalo.mangcoding.com",p=`${(()=>{try{return new URL(u).origin}catch{return u.replace(/\/+$/,"")}})().replace(/\/+$/,"")}/storage`,x=h=>{if(!h)return null;const S=h.trim();if(!S)return null;if(/^https?:\/\//i.test(S))return S;const P=S.replace(/^\/+/,"");return`${p}/${P}`},f=x(s.image_url)??x(s.image),c=typeof s.created_by=="object"?s.created_by?.name??null:s.created_by?String(s.created_by):null,r={id:String(s.id),title:s.title?.trim()||"Untitled notification",content:s.content??s.message??s.description??s.body??"",imageUrl:f,target:Rt(s.target),criteria:s.criteria??null,priority:It(s.priority),scheduleDate:a,status:Tt(s.status),sentAt:n,createdBy:c,createdAt:o,updatedAt:i,resultSummary:s.result_summary??null};return ce.parse(r)}function Et({row:t}){const s=ce.parse(t.original),{setOpen:a,setCurrentRow:n}=le(),{t:o}=F();return e.jsxs(pt,{modal:!1,children:[e.jsx(ht,{asChild:!0,children:e.jsxs(U,{variant:"ghost",className:"data-[state=open]:bg-muted flex h-8 w-8 p-0",children:[e.jsx(mt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:o("push.rowActions.openMenu","Open menu")})]})}),e.jsxs(gt,{align:"end",className:"w-[160px]",children:[e.jsxs(pe,{onClick:()=>{n(s),a("view")},children:[o("push.rowActions.view","View details"),e.jsx(he,{children:e.jsx(xt,{size:16})})]}),e.jsx(ft,{}),e.jsxs(pe,{onClick:()=>{n(s),a("delete")},children:[o("push.rowActions.delete","Delete"),e.jsx(he,{children:e.jsx(bt,{size:16})})]})]})]})}function ge(t){if(typeof t!="string")return null;const a=new Date(t).getTime();return Number.isNaN(a)?null:a}function Ut(t){return[{id:"no",header:({column:s})=>e.jsx(A,{column:s,title:t("push.columns.number","No")}),enableSorting:!1,enableHiding:!1,cell:({row:s,table:a})=>e.jsx("span",{className:"font-mono text-xs",children:dt(a,s.index)}),size:48},{accessorKey:"title",header:({column:s})=>e.jsx(A,{column:s,title:t("push.columns.title","Title")}),cell:({row:s})=>e.jsx("span",{className:"font-medium",children:s.getValue("title")}),enableSorting:!1},{accessorKey:"content",header:({column:s})=>e.jsx(A,{column:s,title:t("push.columns.content","Content")}),cell:({row:s})=>{const a=String(s.getValue("content")??""),n=a.length>50?a.substring(0,50)+"…":a;return e.jsx("span",{className:"text-muted-foreground",children:n})},enableSorting:!1},{accessorKey:"scheduleDate",header:({column:s})=>e.jsx(A,{column:s,title:t("push.columns.scheduleDate","Scheduled Date")}),cell:({row:s})=>{const a=s.getValue("scheduleDate");if(!a)return e.jsx("span",{className:"text-muted-foreground",children:"—"});const n=new Date(a);return Number.isNaN(n.getTime())?e.jsx("span",{className:"text-muted-foreground",children:a}):e.jsx("span",{children:K(n,"dd MMM yyyy HH:mm",{locale:ne})})},enableSorting:!1},{accessorKey:"sentAt",header:({column:s})=>e.jsx(A,{column:s,title:t("push.columns.sentAt","Send At")}),cell:({row:s})=>{const a=s.original.sentAt;if(!a)return e.jsx("span",{className:"text-muted-foreground",children:"—"});const n=new Date(a);return Number.isNaN(n.getTime())?e.jsx("span",{className:"text-muted-foreground",children:a}):e.jsx("span",{children:K(n,"dd MMM yyyy HH:mm",{locale:ne})})},enableSorting:!1},{accessorKey:"createdAt",header:({column:s})=>e.jsx(A,{column:s,title:t("push.columns.createdAt","Created At")}),cell:({row:s})=>{const a=s.getValue("createdAt");if(!a)return e.jsx("span",{className:"text-muted-foreground",children:"—"});const n=new Date(a);return Number.isNaN(n.getTime())?e.jsx("span",{className:"text-muted-foreground",children:a}):e.jsx("span",{children:K(n,"dd MMM yyyy HH:mm",{locale:ne})})},sortingFn:(s,a,n)=>{const o=ge(s.getValue(n)),i=ge(a.getValue(n));return o===null&&i===null?0:o===null?-1:i===null?1:o-i}},{id:"actions",cell:({row:s})=>e.jsx(Et,{row:s})}]}const fe=Ne("/_authenticated/push-notifications/");function $t({data:t,total:s=t.length,pageCount:a,isLoading:n=!1,isFetching:o=!1,sorting:i,onSortingChange:u}){const[g,m]=b.useState({}),[p,x]=b.useState({}),{t:f}=F(),c=b.useMemo(()=>Ut(f),[f]),{globalFilter:r,onGlobalFilterChange:h,columnFilters:S,onColumnFiltersChange:P,pagination:d,onPaginationChange:w,ensurePageInRange:D}=Ze({search:fe.useSearch(),navigate:fe.useNavigate(),pagination:{defaultPage:1,defaultPageSize:10},globalFilter:{enabled:!0,key:"s",trim:!1}}),M=b.useMemo(()=>{if(typeof a=="number"&&a>0)return a;const N=d?.pageSize??10;return N<=0?1:Math.max(1,Math.ceil(s/N))},[a,d?.pageSize,s]),C=Je({data:t,columns:c,state:{sorting:i,columnVisibility:p,rowSelection:g,columnFilters:S,globalFilter:r,pagination:d},enableRowSelection:!0,onRowSelectionChange:m,onSortingChange:u??(()=>{}),onColumnVisibilityChange:x,globalFilterFn:(N,v,te)=>{const Ee=String(N.getValue("id")).toLowerCase(),Ue=String(N.getValue("title")).toLowerCase(),de=String(te).toLowerCase();return Ee.includes(de)||Ue.includes(de)},getCoreRowModel:at(),getFilteredRowModel:st(),getPaginationRowModel:tt(),getSortedRowModel:et(),getFacetedRowModel:We(),getFacetedUniqueValues:Xe(),manualPagination:!0,pageCount:M,autoResetPageIndex:!1,onPaginationChange:w,onGlobalFilterChange:h,onColumnFiltersChange:P});b.useEffect(()=>{!n&&!o&&D(M)},[D,M,n,o]);const I=C.getVisibleLeafColumns(),z=I.length||c.length,Re=Math.min(d?.pageSize?Number(d.pageSize):10,10),ue=n||o,Ie=!ue&&s===0&&t.length===0;return e.jsxs("div",{className:"space-y-4 max-sm:has-[div[role='toolbar']]:mb-16",children:[e.jsx(nt,{table:C,searchPlaceholder:f("push.table.searchPlaceholder","Filter by title or ID...")}),e.jsx("div",{className:"overflow-hidden rounded-md border",children:e.jsxs(it,{children:[e.jsx(rt,{children:C.getHeaderGroups().map(N=>e.jsx(O,{children:N.headers.map(v=>e.jsx(ot,{colSpan:v.colSpan,children:v.isPlaceholder?null:me(v.column.columnDef.header,v.getContext())},v.id))},N.id))}),e.jsx(lt,{children:ue?Array.from({length:Re}).map((N,v)=>e.jsx(O,{children:I.map(te=>e.jsx(ae,{children:e.jsx(ut,{className:"h-4 w-full max-w-[220px]"})},te.id))},`loading-${v}`)):C.getRowModel().rows?.length?C.getRowModel().rows.map(N=>e.jsx(O,{"data-state":N.getIsSelected()&&"selected",children:N.getVisibleCells().map(v=>e.jsx(ae,{children:me(v.column.columnDef.cell,v.getContext())},v.id))},N.id)):e.jsx(O,{children:e.jsx(ae,{colSpan:z,className:"h-24 text-center",children:Ie?f("push.table.empty.noNotifications","No push notifications found."):f("push.table.empty.noResults","No results.")})})})]})}),e.jsx(ct,{table:C})]})}function xe(t){if(!t)return"";try{if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(t))return t;const s=new Date(t);if(isNaN(s.getTime()))return"";const a=n=>String(n).padStart(2,"0");return`${s.getFullYear()}-${a(s.getMonth()+1)}-${a(s.getDate())}T${a(s.getHours())}:${a(s.getMinutes())}`}catch{return""}}const _e=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/;function kt(t){if(!_e.test(t))return null;const[s,a]=t.split("T");if(!s||!a)return null;const[n,o,i]=s.split("-"),[u,g]=a.split(":");if(!n||!o||!i||!u||!g)return null;const m=Number(n),p=Number(o)-1,x=Number(i),f=Number(u),c=Number(g);return[m,p,x,f,c].some(r=>Number.isNaN(r))?null:new Date(m,p,x,f,c)}const Lt=5*1024*1024,Fe="5 MB";function Q(t){return typeof File<"u"&&t instanceof File}function zt(t){return!Number.isFinite(t)||t<=0?"":t>=1024*1024?`${(t/(1024*1024)).toFixed(1)} MB`:t>=1024?`${(t/1024).toFixed(1)} KB`:`${t} B`}const Ot=t=>y({title:l().min(1,t("push.form.validation.titleRequired","Title is required")).max(100,t("push.form.validation.titleMax","Title is too long")),message:l().min(1,t("push.form.validation.messageRequired","Message is required")).max(1e3,t("push.form.validation.messageMax","Message is too long")),scheduleAt:l().optional(),imageFile:$e(s=>s==null||Q(s),{message:t("push.form.validation.imageType","Please upload a valid image file.")}).refine(s=>s==null||!Q(s)||!s.type||s.type.startsWith("image/"),{message:t("push.form.validation.imageFormat","Image must be a PNG, JPG, or GIF.")}).refine(s=>s==null||!Q(s)||s.size<=Lt,{message:t("push.form.validation.imageSize",`Image must be ${Fe} or smaller.`)}).optional()}).superRefine((s,a)=>{const n=s.scheduleAt?.trim();if(!n)return;if(!_e.test(n)){a.addIssue({code:se.custom,path:["scheduleAt"],message:t("push.form.validation.scheduleFormat","Send date must use the YYYY-MM-DDTHH:mm format.")});return}const o=kt(n);if(!o){a.addIssue({code:se.custom,path:["scheduleAt"],message:t("push.form.validation.scheduleInvalid","Send date is invalid.")});return}o.getTime()<Date.now()&&a.addIssue({code:se.custom,path:["scheduleAt"],message:t("push.form.validation.schedulePast","Send date cannot be in the past.")})});function be({open:t,onOpenChange:s,currentRow:a,onSubmit:n}){const o=a?"update":"create",{t:i}=F(),u=b.useMemo(()=>Ot(i),[i]),g=b.useMemo(()=>({title:a?.title??"",message:a?.content??"",scheduleAt:xe(a?.scheduleDate??void 0),imageFile:null}),[a]),m=jt({resolver:yt(u),defaultValues:g}),p=a?.imageUrl??null,[x,f]=b.useState(p),c=b.useRef(null),r=d=>{if(c.current&&(URL.revokeObjectURL(c.current),c.current=null),d){const w=URL.createObjectURL(d);c.current=w,f(w)}else f(p)},h=b.useMemo(()=>t?xe(new Date().toISOString()):"",[t]);b.useEffect(()=>()=>{c.current&&(URL.revokeObjectURL(c.current),c.current=null)},[]),b.useEffect(()=>{t?m.reset(g):m.reset({title:"",message:"",scheduleAt:"",imageFile:null}),c.current&&(URL.revokeObjectURL(c.current),c.current=null),f(p)},[t,g,m,p]);const S=async d=>{const w=d.scheduleAt&&d.scheduleAt.trim().length>0?d.scheduleAt.trim():"",D={...d,scheduleAt:w};n?await n(D,a??null):St(D,o==="create"?i("push.toast.create","You have created the following push notification:"):i("push.toast.update","You have updated the following push notification:")),s(!1),m.reset()},{isSubmitting:P}=m.formState;return e.jsx(Se,{open:t,onOpenChange:d=>{s(d),d||m.reset()},children:e.jsxs(ve,{className:"gap-2 sm:max-w-lg",children:[e.jsxs(Pe,{className:"text-start",children:[e.jsx(De,{children:o==="create"?i("push.form.dialog.createTitle","Create Push Notification"):i("push.form.dialog.updateTitle","Update Push Notification")}),e.jsx(Ce,{children:o==="create"?i("push.form.dialog.createDescription","Compose a push notification to send now or schedule later."):i("push.form.dialog.updateDescription","Edit the push notification details below.")})]}),e.jsx(wt,{...m,children:e.jsxs("form",{id:"push-upsert-form",onSubmit:m.handleSubmit(S),className:"space-y-4",children:[e.jsx(V,{control:m.control,name:"title",render:({field:d})=>e.jsxs(H,{children:[e.jsx(B,{children:i("push.form.fields.title.label","Title")}),e.jsx(q,{children:e.jsx(re,{placeholder:i("push.form.fields.title.placeholder","Stay Hydrated!"),...d})}),e.jsx(G,{})]})}),e.jsx(V,{control:m.control,name:"message",render:({field:d})=>e.jsxs(H,{children:[e.jsx(B,{children:i("push.form.fields.message.label","Message")}),e.jsx(q,{children:e.jsx(Dt,{placeholder:i("push.form.fields.message.placeholder","Drink a glass of water to keep your body fresh."),className:"min-h-[120px]",...d})}),e.jsx(G,{})]})}),e.jsx(V,{control:m.control,name:"imageFile",render:({field:d})=>{const w=d.value&&Q(d.value)?d.value:null,D=w?.name??a?.title??i("push.form.fields.image.previewAlt","Notification image preview"),M=I=>{const z=I.target.files?.[0]??null;d.onChange(z),r(z),I.target.value=""},C=()=>{d.onChange(null),r(null)};return e.jsxs(H,{children:[e.jsx(B,{children:i("push.form.fields.image.label","Image (optional)")}),e.jsx(q,{children:e.jsx(re,{type:"file",accept:"image/*",onChange:M})}),e.jsx(Nt,{children:i("push.form.fields.image.description",`Upload a PNG or JPG up to ${Fe}.`)}),e.jsxs("div",{className:"mt-3 space-y-2",children:[x?e.jsxs("div",{className:"relative overflow-hidden rounded-md border border-border/60 bg-muted/10",children:[e.jsx("img",{src:x,alt:D,className:"h-48 w-full object-cover",loading:"lazy"}),w?e.jsx("span",{className:"absolute right-2 top-2 rounded-md bg-background/80 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-foreground shadow",children:i("push.form.fields.image.previewBadge","Preview")}):null]}):e.jsx("div",{className:"flex h-32 items-center justify-center rounded-md border border-dashed border-border/60 bg-muted/10 text-sm text-muted-foreground",children:i("push.form.fields.image.noPreview","No image selected")}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[w?e.jsx("span",{children:i("push.form.fields.image.selected","Selected: {name} ({size})").replace("{name}",w.name).replace("{size}",zt(w.size)||`${w.size} B`)}):p?e.jsxs("span",{className:"flex flex-wrap items-center gap-2",children:[i("push.form.fields.image.currentInfo","Current image will be kept unless you upload a new one."),e.jsx("a",{href:p,target:"_blank",rel:"noreferrer",className:"text-primary underline-offset-2 hover:underline",children:i("push.form.fields.image.open","View image")})]}):e.jsx("span",{children:i("push.form.fields.image.noSelection","No image selected yet.")}),w?e.jsx(U,{type:"button",variant:"ghost",size:"sm",className:"h-7 px-2",onClick:C,children:i("push.form.fields.image.clear","Clear selection")}):null]})]}),e.jsx(G,{})]})}}),e.jsx(V,{control:m.control,name:"scheduleAt",render:({field:d})=>e.jsxs(H,{children:[e.jsx(B,{children:i("push.form.fields.schedule.label","Schedule send time")}),e.jsx(q,{children:e.jsx(re,{className:"w-fit",type:"datetime-local",placeholder:i("push.form.fields.schedule.placeholder","Optional"),min:h||void 0,...d})}),e.jsx(G,{})]})})]})}),e.jsxs(vt,{className:"gap-2",children:[e.jsx(Pt,{asChild:!0,children:e.jsx(U,{variant:"outline",disabled:P,children:i("push.form.buttons.close","Close")})}),e.jsx(U,{type:"submit",form:"push-upsert-form",disabled:P,children:P?o==="create"?i("push.form.buttons.creating","Creating..."):i("push.form.buttons.updating","Updating..."):o==="create"?i("push.form.buttons.create","Create"):i("push.form.buttons.update","Update")})]})]})})}const Vt=y({data:Z(R),current_page:j().int().nonnegative(),per_page:j().int().positive(),total:j().int().nonnegative(),last_page:j().int().nonnegative().optional(),next_page_url:l().nullable().optional(),prev_page_url:l().nullable().optional()}),Ht=y({total:j().int().nonnegative(),per_page:j().int().positive(),current_page:j().int().nonnegative(),last_page:j().int().nonnegative().optional(),from:j().int().nonnegative().optional(),to:j().int().nonnegative().optional(),next_page_url:l().nullable().optional(),prev_page_url:l().nullable().optional()}),Bt=y({items:Z(R),pagination:Ht}),qt=y({message:l().optional(),data:oe([Vt,Bt]).optional()}),Gt=y({message:l().optional(),data:Z(R).optional()});function Yt({page:t=1,perPage:s=10,sort:a,search:n}){return{page:t,per_page:s,...a?{sort:a}:{},...n&&n.trim().length>0?{s:n.trim()}:{}}}async function Kt(t={}){const{page:s=1,perPage:a=10}=t,n=await J.get("/api/admin/push-notifications",{params:Yt(t)}),o=qt.safeParse(n.data);if(o.success&&o.data.data){const{data:u,message:g}=o.data;if("data"in u){const{data:m,current_page:p,per_page:x,total:f,last_page:c,next_page_url:r,prev_page_url:h}=u;return{notifications:m.map($),pagination:{page:p,perPage:x,total:f,lastPage:c,hasNext:typeof r<"u"?!!r:typeof c=="number"?p<c:!1,hasPrevious:typeof h<"u"?!!h:p>1},rawMessage:g}}if("items"in u){const{items:m,pagination:{current_page:p,per_page:x,total:f,last_page:c,next_page_url:r,prev_page_url:h}}=u;return{notifications:m.map($),pagination:{page:p,perPage:x,total:f,lastPage:c,hasNext:typeof r<"u"?!!r:typeof c=="number"?p<c:!1,hasPrevious:typeof h<"u"?!!h:p>1},rawMessage:g}}}const i=Gt.safeParse(n.data);if(i.success&&i.data.data){const u=i.data.data.map($),g=u.length;return{notifications:u,pagination:{page:s,perPage:a,total:g,lastPage:Math.max(1,Math.ceil(g/a)),hasNext:!1,hasPrevious:s>1&&s<=Math.ceil(g/a)},rawMessage:i.data.message}}throw new Error("Unable to parse push notifications response.")}const Ae=["admin","push-notifications"];function Qt({page:t,perPage:s,sort:a,search:n,enabled:o=!0}){return Ve({queryKey:[...Ae,{page:t??1,perPage:s??10,sort:a??"desc",search:n??""}],queryFn:()=>Kt({page:t,perPage:s,sort:a,search:n}),placeholderData:ke,enabled:o,staleTime:1e3*30})}function Zt(t){switch(t){case"scheduled":return"publish";case"sending":return"sending";case"sent":return"sent";case"canceled":return"canceled";case"failed":return"failed";case"draft":default:return"draft"}}function Jt(t){if(!t)return null;const s=t.trim();if(!s)return null;const a=new Date(s);if(!Number.isNaN(a.getTime())){const n=o=>String(o).padStart(2,"0");return`${a.getFullYear()}-${n(a.getMonth()+1)}-${n(a.getDate())} ${n(a.getHours())}:${n(a.getMinutes())}:${n(a.getSeconds())}`}return s}function Te(t){if(!ee.safeParse(t.status).success)throw new Error("Invalid status value");const s=Jt(t.scheduleDate),a={title:t.title,content:t.content,message:t.content,status:Zt(t.status)};if(s!==null&&(a.schedule_at=s,a.scheduled_at=s),t.target&&X.includes(t.target)&&(a.target=t.target),t.priority&&W.includes(t.priority)&&(a.priority=t.priority),typeof File<"u"&&t.imageFile instanceof File&&t.imageFile){const o=new FormData;return Object.entries(a).forEach(([i,u])=>{u!=null&&o.append(i,String(u))}),o.append("image",t.imageFile),o}return a}const Xt=y({message:l().optional(),data:R.optional()});async function Wt(t){const s=await J.post("/api/admin/push-notifications",Te(t)),a=Xt.safeParse(s.data);if(!a.success)throw new Error("Unable to parse create response.");return{notification:a.data.data?$(a.data.data):void 0,message:a.data.message}}const es=y({message:l().optional(),data:R.optional()});async function ts(t,s){const a=await J.put(`/api/admin/push-notifications/${t}`,Te(s)),n=es.safeParse(a.data);if(!n.success)throw new Error("Unable to parse update response.");return{notification:n.data.data?$(n.data.data):void 0,message:n.data.message}}const ss=y({message:l().optional()});async function as(t){const s=await J.delete(`/api/admin/push-notifications/${t}`),a=ss.safeParse(s.data);if(!a.success)throw new Error("Unable to parse delete response.");return a.data.message}function Y(t){if(!t)return{display:"—",raw:null};const s=new Date(t);return Number.isNaN(s.getTime())?{display:t,raw:t}:{display:K(s,"dd MMM yyyy HH:mm"),raw:t}}function E(t){if(!t)return"—";const s=t.trim();return s.length>0?s:"—"}function ns(t){if(t===null||typeof t>"u")return"";if(typeof t=="string")return t;try{return JSON.stringify(t,null,2)}catch{return String(t)}}function is({notification:t,open:s,onOpenChange:a}){const{t:n}=F();if(!t)return null;const o=Y(t.scheduleDate),i=Y(t.sentAt),u=Y(t.createdAt),g=Y(t.updatedAt),m=t.resultSummary!==null&&typeof t.resultSummary<"u",p=typeof t.imageUrl=="string"&&t.imageUrl.trim().length>0;return e.jsx(Se,{open:s,onOpenChange:a,children:e.jsxs(ve,{className:"sm:max-w-2xl",children:[e.jsxs(Pe,{children:[e.jsx(De,{children:n("push.view.title","Push notification detail")}),e.jsx(Ce,{children:E(t.title)})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("section",{className:"space-y-4",children:e.jsxs("dl",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("dt",{className:"text-xs uppercase text-muted-foreground",children:n("push.view.target","Target")}),e.jsx("dd",{className:"text-sm",children:n(`push.target.${t.target}`,E(t.target))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("dt",{className:"text-xs uppercase text-muted-foreground",children:n("push.view.priority","Priority")}),e.jsx("dd",{className:"text-sm",children:n(`push.priority.${t.priority}`,E(t.priority))})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("dt",{className:"text-xs uppercase text-muted-foreground",children:n("push.view.scheduleDate","Schedule Date")}),e.jsx("dd",{className:"text-sm",children:o.display})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("dt",{className:"text-xs uppercase text-muted-foreground",children:n("push.view.sendAt","Send At (send_at)")}),e.jsxs("dd",{className:"text-sm space-y-1",children:[e.jsx("span",{children:i.display}),i.raw&&i.raw!==i.display&&e.jsxs("span",{className:"block text-xs text-muted-foreground",children:[n("push.view.rawLabel","Raw:")," ",i.raw]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("dt",{className:"text-xs uppercase text-muted-foreground",children:n("push.view.createdAt","Created At")}),e.jsx("dd",{className:"text-sm",children:u.display})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("dt",{className:"text-xs uppercase text-muted-foreground",children:n("push.view.updatedAt","Updated At")}),e.jsx("dd",{className:"text-sm",children:g.display})]})]})}),p&&e.jsxs("section",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase text-muted-foreground",children:n("push.view.imageLabel","Image")}),e.jsx("div",{className:"flex flex-col gap-3 rounded-md border bg-muted/30 p-3 sm:flex-row sm:items-center",children:e.jsx("div",{className:"w-full overflow-hidden rounded-md border border-border/60 bg-background",children:e.jsx("img",{src:t.imageUrl??void 0,alt:t.title??"Notification image",className:"h-full w-full object-cover",loading:"lazy"})})})]}),e.jsxs("section",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase text-muted-foreground",children:n("push.view.titleLabel","Title")}),e.jsx("p",{className:"rounded-md border bg-muted/40 p-3 text-sm font-medium",children:E(t.title)})]}),e.jsxs("section",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase text-muted-foreground",children:n("push.view.contentLabel","Content")}),e.jsx("p",{className:"rounded-md border bg-muted/40 p-3 text-sm whitespace-pre-wrap",children:E(t.content)})]}),m&&e.jsxs("section",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold uppercase text-muted-foreground",children:n("push.view.resultSummary","Result Summary")}),e.jsx("pre",{className:"rounded-md border bg-muted/30 p-3 text-xs overflow-x-auto",children:ns(t.resultSummary)})]})]})]})})}function rs(t){return t?"scheduled":"draft"}function je(t){const s=t.scheduleAt?.trim()??"",a=s.length>0?s:null;return{title:t.title.trim(),content:t.message.trim(),status:rs(a),scheduleDate:a,target:"all",priority:"normal",imageFile:t.imageFile??null}}function os(){const{open:t,setOpen:s,currentRow:a,setCurrentRow:n}=le(),o=Le(),{t:i}=F(),u=b.useCallback(async()=>{await o.invalidateQueries({queryKey:Ae})},[o]),g=ie({mutationFn:async r=>Wt(je(r)),onSuccess:async r=>{await u(),_.success(r.message??i("push.api.createSuccess","Push notification created successfully.")),s(null)},onError:r=>{const h=r instanceof Error?r.message:i("push.api.createError","Failed to create push notification.");_.error(h)}}),m=ie({mutationFn:async({id:r,values:h})=>ts(r,je(h)),onSuccess:async r=>{await u(),_.success(r.message??i("push.api.updateSuccess","Push notification updated successfully.")),s(null),n(null)},onError:r=>{const h=r instanceof Error?r.message:i("push.api.updateError","Failed to update push notification.");_.error(h)}}),p=ie({mutationFn:async r=>as(r),onSuccess:async r=>{await u(),_.success(r??i("push.api.deleteSuccess","Push notification deleted successfully.")),s(null),n(null)},onError:r=>{const h=r instanceof Error?r.message:i("push.api.deleteError","Failed to delete push notification.");_.error(h)}}),x=async r=>{await g.mutateAsync(r)},f=async(r,h)=>{h&&await m.mutateAsync({id:h.id,values:r})},c=async()=>{a&&await p.mutateAsync(a.id)};return e.jsxs(e.Fragment,{children:[e.jsx(be,{open:t==="create",onOpenChange:r=>s(r?"create":null),onSubmit:x},"push-notifications-create"),a&&e.jsxs(e.Fragment,{children:[e.jsx(be,{open:t==="update",onOpenChange:r=>{r?s("update"):(s(null),n(null))},currentRow:a,onSubmit:r=>f(r,a)},`push-notifications-update-${a.id}`),e.jsx(He,{destructive:!0,open:t==="delete",onOpenChange:r=>{r?s("delete"):(s(null),n(null))},handleConfirm:()=>{c()},isLoading:p.isPending,className:"max-w-md",title:i("push.dialog.delete.title","Delete push notification: {title}?").replace("{title}",a.title||a.id),desc:i("push.dialog.delete.desc","You are about to delete the push notification {title}. This action cannot be undone.").replace("{title}",a.title||a.id),confirmText:i("push.dialog.delete.confirm","Delete")},`push-notifications-delete-${a.id}`),e.jsx(is,{open:t==="view",onOpenChange:r=>{r?s("view"):(s(null),n(null))},notification:a},`push-notifications-view-${a.id}`)]})]})}const ye=Ne("/_authenticated/push-notifications/");function ls(){const t=ye.useSearch(),s=ye.useNavigate(),{t:a}=F(),n=t.page??1,o=t.pageSize??10,i=t.sort==="asc"?"asc":"desc",u=typeof t.s=="string"&&t.s.trim().length>0?t.s:void 0,{data:g,isLoading:m,isFetching:p,error:x}=Qt({page:n,perPage:o,sort:i,search:u});b.useEffect(()=>{x instanceof Error&&_.error(x.message)},[x]);const f=g?.notifications??[],c=g?.pagination.total??0,r=b.useMemo(()=>g?.pagination.lastPage&&g.pagination.lastPage>0?g.pagination.lastPage:o>0?Math.max(1,Math.ceil(c/o)):1,[g?.pagination.lastPage,c,o]),h=b.useMemo(()=>[{id:"createdAt",desc:i!=="asc"}],[i]),S=b.useCallback(P=>{const D=(typeof P=="function"?P(h):P)[0]?.desc===!1?"asc":"desc";s({search:M=>({...M,page:void 0,sort:D==="desc"?void 0:D})})},[s,h]);return e.jsxs(Ct,{children:[e.jsxs(Be,{fixed:!0,children:[e.jsx(qe,{}),e.jsxs("div",{className:"ms-auto flex items-center space-x-4",children:[e.jsx(Ke,{}),e.jsx(ze,{}),e.jsx(Ye,{})]})]}),e.jsxs(Ge,{children:[e.jsxs("div",{className:"mb-2 flex flex-wrap items-center justify-between space-y-2 gap-x-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:a("push.page.title","Push Notifications")}),e.jsx("p",{className:"text-muted-foreground",children:a("push.page.description","Here's a list of your push notifications!")})]}),e.jsx(Mt,{})]}),e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-y-0 lg:space-x-12",children:e.jsx($t,{data:f,total:c,pageCount:r,isLoading:m,isFetching:p,sorting:h,onSortingChange:S})})]}),e.jsx(os,{})]})}const Qs=ls;export{Qs as component};
