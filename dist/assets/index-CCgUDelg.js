import{r as j,j as e,R as O,o as S,w as re,s as r,x as oe,y as A,n as x,B as H,i as $,z as ne,C as le,h as U,k as ie,D as ce,t as z}from"./index-PJSoALqW.js";import{a as pe,u as ue,H as de,S as me}from"./search-DNskT_XA.js";import{M as ge}from"./main-DIftAsZN.js";import{T as he}from"./theme-switch-D16jziMJ.js";import{C as xe}from"./config-drawer-DIpi6UgC.js";import{P as fe}from"./profile-dropdown-zkoeqgxu.js";import{D as R,u as be,a as je,g as Se,b as _e,d as ve,c as we,e as Re,f as ye,h as Ce,T as Pe,i as De,j as N,k as Me,l as K,m as Ne,n as F,o as Ee}from"./toolbar-FoxzrVPf.js";import{S as Te}from"./skeleton-Dz89h62O.js";import{B as Fe}from"./badge-Wr05xGak.js";import{g as ke}from"./get-row-serial-lFSYfpsv.js";import{D as Ve}from"./react-icons.esm-1898j_IC.js";import{D as He,f as ze,g as Ae,j as Ue}from"./dropdown-menu-C13Htoa9.js";import{i as Be,u as Ie}from"./id-Bl4OMirq.js";import{f as Ke}from"./format-DMm6umYn.js";import{a as G}from"./api-client-d_HjdnGb.js";import{D as qe,a as Le,b as Qe,c as Oe,d as $e,e as Ge}from"./command-Ckdq_yr7.js";import{S as Je,a as We,b as Xe,c as Ye,d as Ze}from"./select-BVNy0vOO.js";import"./separator-FNUfim07.js";import"./index-mV3cxRO_.js";import"./index-CzxQJnmd.js";import"./index-By7kRSW8.js";import"./index-CnZH9FRD.js";import"./check-CWRdaoHi.js";import"./index-CpUZSOZN.js";import"./index-FEBST65e.js";import"./index-DgPcTN26.js";import"./index-n3OEIJtS.js";import"./index-B2ibKlVn.js";import"./layout-provider-BCzdurxv.js";import"./input-jRkzR5wK.js";import"./popover-oHmeJmNB.js";import"./index-B4y4BuXJ.js";import"./index-CKm0aj0N.js";import"./chevron-down-DWwXMWh-.js";const J=O.createContext(null);function et({children:t}){const[a,s]=pe(null),[o,n]=j.useState(null);return e.jsx(J.Provider,{value:{open:a,setOpen:s,currentRow:o,setCurrentRow:n},children:t})}function W(){const t=O.useContext(J);if(!t)throw new Error("useReports must be used within <ReportsProvider>");return t}const tt=oe(["pending","resolve"]),X=S({id:r(),reporterEmail:r(),reportedEmail:r(),reason:r(),status:tt,createdAt:re().nullable()}),y=S({email:r().nullable().optional()}).partial().optional().nullable(),at=S({id:A([r(),x()]),reporter_email:r().nullable().optional(),reporter:y,reporter_user:y,reporter_user_email:r().nullable().optional(),reported_email:r().nullable().optional(),reported:y,reported_user:y,target_email:r().nullable().optional(),target_user:y,reason:r().nullable().optional(),message:r().nullable().optional(),description:r().nullable().optional(),notes:r().nullable().optional(),status:r().nullable().optional(),state:r().nullable().optional(),created_at:r().nullable().optional(),updated_at:r().nullable().optional()});function k(...t){for(const a of t)if(typeof a=="string"){const s=a.trim();if(s.length>0&&s.toLowerCase()!=="null")return s}return""}function st(t){return(t??"").toLowerCase()==="resolve"?"resolve":"pending"}function rt(t){if(!t)return null;const a=new Date(t);return Number.isNaN(a.getTime())?null:a}function V(t){const a=at.parse(t),s=k(a.reporter_email,a.reporter_user_email,a.reporter?.email,a.reporter_user?.email),o=k(a.reported_email,a.target_email,a.reported?.email,a.reported_user?.email,a.target_user?.email),n=k(a.reason,a.message,a.description,a.notes)||"No reason provided",u={id:String(a.id),reporterEmail:s||"Unknown",reportedEmail:o||"Unknown",reason:n,status:st(a.status??a.state),createdAt:rt(a.created_at??a.updated_at)};return X.parse(u)}function ot({row:t}){const{setCurrentRow:a,setOpen:s}=W(),o=X.parse(t.original);return e.jsxs(He,{modal:!1,children:[e.jsx(ze,{asChild:!0,children:e.jsxs(H,{variant:"ghost",className:"flex h-8 w-8 p-0 data-[state=open]:bg-muted",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Open menu"})]})}),e.jsx(Ae,{align:"end",className:"w-[160px]",children:e.jsx(Ue,{onClick:()=>{a(o),s("status")},children:"Update Status"})})]})}const q=[{id:"no",header:({column:t})=>e.jsx(R,{column:t,title:"No"}),enableSorting:!1,enableHiding:!1,size:48,cell:({row:t,table:a})=>e.jsx("span",{className:"font-mono text-xs",children:ke(a,t.index)})},{accessorKey:"reporterEmail",header:({column:t})=>e.jsx(R,{column:t,title:"Reporter"}),cell:({row:t})=>e.jsx("span",{className:"font-medium",children:t.original.reporterEmail}),enableSorting:!1},{accessorKey:"reportedEmail",header:({column:t})=>e.jsx(R,{column:t,title:"Reported User"}),cell:({row:t})=>e.jsx("span",{children:t.original.reportedEmail}),enableSorting:!1},{accessorKey:"reason",header:({column:t})=>e.jsx(R,{column:t,title:"Reason"}),cell:({row:t})=>{const a=t.original.reason;return e.jsx("span",{className:"text-sm text-muted-foreground",children:a})},enableSorting:!1},{accessorKey:"status",header:({column:t})=>e.jsx(R,{column:t,title:"Status"}),cell:({row:t})=>{const a=t.original.status,s=a==="resolve"?"default":"secondary";return e.jsx(Fe,{variant:s,children:a})}},{accessorKey:"createdAt",header:({column:t})=>e.jsx(R,{column:t,title:"Created"}),cell:({row:t})=>{const a=t.original.createdAt;return a?e.jsx("span",{children:Ke(a,"dd MMM yyyy HH:mm",{locale:Be})}):e.jsx("span",{className:"text-muted-foreground",children:"—"})},sortingFn:"datetime"},{id:"actions",cell:({row:t})=>e.jsx(ot,{row:t})}],Y=[{label:"Pending",value:"pending"},{label:"Resolved",value:"resolve"}],L=$("/_authenticated/reports/");function nt({data:t,total:a,pageCount:s,isLoading:o,isFetching:n,sorting:u,onSortingChange:i}){const[c,g]=j.useState({}),{globalFilter:d,onGlobalFilterChange:l,columnFilters:f,onColumnFiltersChange:_,pagination:v,onPaginationChange:b,ensurePageInRange:w}=be({search:L.useSearch(),navigate:L.useNavigate(),pagination:{defaultPage:1,defaultPageSize:10},globalFilter:{enabled:!0,key:"s",trim:!0},columnFilters:[{columnId:"status",searchKey:"status",type:"string"}]}),h=je({data:j.useMemo(()=>t,[t]),columns:q,state:{sorting:u,columnVisibility:c,globalFilter:d,columnFilters:f,pagination:v},manualPagination:!0,pageCount:s,manualSorting:!0,autoResetPageIndex:!1,onPaginationChange:b,onSortingChange:i,onColumnFiltersChange:_,onGlobalFilterChange:l,onColumnVisibilityChange:g,getCoreRowModel:ye(),getFilteredRowModel:Re(),getSortedRowModel:we(),getPaginationRowModel:ve(),getFacetedRowModel:_e(),getFacetedUniqueValues:Se(),globalFilterFn:(p,m,M)=>{if(!M)return!0;const T=String(M).toLowerCase(),te=String(p.getValue("reporterEmail")).toLowerCase(),ae=String(p.getValue("reportedEmail")).toLowerCase(),se=String(p.getValue("reason")).toLowerCase();return te.includes(T)||ae.includes(T)||se.includes(T)}});j.useEffect(()=>{!o&&!n&&w(s)},[w,s,n,o]);const E=h.getVisibleLeafColumns(),I=E.length||q.length,P=Math.min(h.getState().pagination?.pageSize??10,10),D=o||n,ee=a===0&&!D;return e.jsxs("div",{className:"space-y-4 max-sm:has-[div[role='toolbar']]:mb-16",children:[e.jsx(Ce,{table:h,searchPlaceholder:"Filter by reporter, reported user, or reason...",filters:[{columnId:"status",title:"Status",options:Y.map(p=>({label:p.label,value:p.value}))}]}),e.jsx("div",{className:"overflow-hidden rounded-md border",children:e.jsxs(Pe,{children:[e.jsx(De,{children:h.getHeaderGroups().map(p=>e.jsx(N,{children:p.headers.map(m=>e.jsx(Me,{colSpan:m.colSpan,children:m.isPlaceholder?null:K(m.column.columnDef.header,m.getContext())},m.id))},p.id))}),e.jsx(Ne,{children:D?Array.from({length:P}).map((p,m)=>e.jsx(N,{children:E.map(M=>e.jsx(F,{children:e.jsx(Te,{className:"h-4 w-full max-w-[220px]"})},M.id))},`loading-${m}`)):h.getRowModel().rows?.length?h.getRowModel().rows.map(p=>e.jsx(N,{children:p.getVisibleCells().map(m=>e.jsx(F,{children:K(m.column.columnDef.cell,m.getContext())},m.id))},p.id)):e.jsx(N,{children:e.jsx(F,{colSpan:I,className:"h-24 text-center",children:ee?"No reports found.":"No results."})})})]})}),e.jsx(Ee,{table:h})]})}const C=ne(r(),le()),B=S({id:A([r(),x()]),reporter_email:r().nullable().optional(),reporter_user_email:r().nullable().optional(),reporter:C.nullable().optional(),reporter_user:C.nullable().optional(),reported_email:r().nullable().optional(),target_email:r().nullable().optional(),reported:C.nullable().optional(),reported_user:C.nullable().optional(),target_user:C.nullable().optional(),reason:r().nullable().optional(),message:r().nullable().optional(),description:r().nullable().optional(),notes:r().nullable().optional(),status:r().nullable().optional(),state:r().nullable().optional(),created_at:r().nullable().optional(),updated_at:r().nullable().optional()}),lt=S({data:U(B),current_page:x().int().nonnegative(),per_page:x().int().positive(),total:x().int().nonnegative(),last_page:x().int().nonnegative().optional(),next_page_url:r().nullable().optional(),prev_page_url:r().nullable().optional()}),it=S({items:U(B),pagination:S({current_page:x().int().nonnegative(),per_page:x().int().positive(),total:x().int().nonnegative(),last_page:x().int().nonnegative().optional(),next_page_url:r().nullable().optional(),prev_page_url:r().nullable().optional()})}),ct=S({message:r().optional(),data:A([lt,it]).optional()}),pt=S({message:r().optional(),data:U(B).optional()});function ut({page:t=1,perPage:a=10,search:s,status:o,sort:n}){return{page:t,per_page:a,...s&&s.trim().length>0?{s:s.trim()}:{},...o&&o.trim().length>0?{status:o.trim()}:{},...n?{sort:n}:{}}}async function dt(t={}){const{page:a=1,perPage:s=10}=t,o=await G.get("/api/admin/reports",{params:ut(t)}),n=ct.safeParse(o.data);if(n.success&&n.data.data){const{data:i,message:c}=n.data;if("data"in i){const{data:g,current_page:d,per_page:l,total:f,last_page:_,next_page_url:v,prev_page_url:b}=i;return{reports:g.map(V),pagination:{page:d,perPage:l,total:f,lastPage:_,hasNext:!!v,hasPrevious:!!b},rawMessage:c}}if("items"in i){const{items:g,pagination:{current_page:d,per_page:l,total:f,last_page:_,next_page_url:v,prev_page_url:b}}=i;return{reports:g.map(V),pagination:{page:d,perPage:l,total:f,lastPage:_,hasNext:!!v,hasPrevious:!!b},rawMessage:c}}}const u=pt.safeParse(o.data);if(u.success&&u.data.data){const i=u.data.data.map(V),c=i.length;return{reports:i,pagination:{page:a,perPage:s,total:c,lastPage:Math.max(1,Math.ceil(c/s)),hasNext:!1,hasPrevious:a>1&&a<=Math.ceil(c/s)},rawMessage:u.data.message}}throw new Error("Unable to parse reports response.")}const Z=["admin","reports"];function mt({page:t,perPage:a,search:s,status:o,enabled:n=!0}){return ue({queryKey:[...Z,{page:t??1,perPage:a??10,search:s??"",status:o??""}],queryFn:()=>dt({page:t??1,perPage:a??10,search:s??"",status:o??""}),placeholderData:ie,enabled:n,staleTime:1e3*30})}async function gt(t,a){const s=await G.put(`/api/admin/reports/${t}`,a);return s.data&&typeof s.data.message=="string"?s.data.message:"Report status updated successfully."}function ht(){const{open:t,setOpen:a,currentRow:s,setCurrentRow:o}=W();return s?e.jsx(xt,{open:t==="status",onOpenChange:n=>{n?a("status"):(o(null),a(null))},reportId:s.id,initialStatus:s.status,reporterEmail:s.reporterEmail,reportedEmail:s.reportedEmail}):null}function xt({open:t,onOpenChange:a,reportId:s,initialStatus:o,reporterEmail:n,reportedEmail:u}){const[i,c]=j.useState(o),g=ce();j.useEffect(()=>{t&&c(o)},[o,t]);const d=Ie({mutationFn:async l=>gt(s,{status:l}),onSuccess:async l=>{await g.invalidateQueries({queryKey:Z,exact:!1}),z.success(l??"Report status updated."),a(!1)},onError:l=>{const f=l instanceof Error?l.message:"Failed to update report.";z.error(f)}});return e.jsx(qe,{open:t,onOpenChange:a,children:e.jsxs(Le,{className:"sm:max-w-md",children:[e.jsxs(Qe,{children:[e.jsx(Oe,{children:"Update Report Status"}),e.jsxs($e,{children:["Reporter: ",e.jsx("strong",{children:n})," · Reported user: ",e.jsx("strong",{children:u})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Status"}),e.jsxs(Je,{value:i,onValueChange:l=>c(l),children:[e.jsx(We,{className:"w-full",children:e.jsx(Xe,{placeholder:"Select status"})}),e.jsx(Ye,{children:Y.map(l=>e.jsx(Ze,{value:l.value,children:l.label},l.value))})]})]}),e.jsxs(Ge,{children:[e.jsx(H,{variant:"outline",onClick:()=>a(!1),disabled:d.isPending,children:"Cancel"}),e.jsx(H,{onClick:()=>d.mutate(i),disabled:d.isPending,children:d.isPending?"Saving...":"Save"})]})]})})}const Q=$("/_authenticated/reports/");function ft(){const t=Q.useSearch(),a=Q.useNavigate(),s=t.page??1,o=t.pageSize??10,n=typeof t.s=="string"&&t.s.trim().length>0?t.s:void 0,u=typeof t.status=="string"&&t.status.trim().length>0?t.status:void 0,i=t.sort==="asc"?"asc":"desc",{data:c,error:g,isLoading:d,isFetching:l}=mt({page:s,perPage:o,search:n,status:u});j.useEffect(()=>{g instanceof Error&&z.error(g.message)},[g]);const f=c?.reports??[],_=c?.pagination.total??0,v=c?.pagination.lastPage??(o>0?Math.max(1,Math.ceil(_/(o||1))):1),b=j.useMemo(()=>[{id:"createdAt",desc:i!=="asc"}],[i]),w=j.useCallback(h=>{const P=(typeof h=="function"?h(b):h)[0]?.desc===!1?"asc":"desc";a({search:D=>({...D,page:void 0,sort:P==="desc"?void 0:P})})},[a,b]);return e.jsxs(et,{children:[e.jsxs(de,{fixed:!0,children:[e.jsx(me,{}),e.jsxs("div",{className:"ms-auto flex items-center space-x-4",children:[e.jsx(he,{}),e.jsx(xe,{}),e.jsx(fe,{})]})]}),e.jsxs(ge,{children:[e.jsx("div",{className:"mb-2 flex flex-wrap items-center justify-between gap-4",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"Reports"}),e.jsx("p",{className:"text-muted-foreground",children:"Review and resolve user reports."})]})}),e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(nt,{data:f,total:_,pageCount:v,isLoading:d,isFetching:l,sorting:b,onSortingChange:w})})]}),e.jsx(ht,{})]})}const Yt=ft;export{Yt as component};
